Resources:

  IngestionQueue:
    Type: AWS::SQS::Queue
    Properties:
      QueueName: ${self:custom.basename}-ingestion-queue.fifo
      FifoQueue: true
      ContentBasedDeduplication: true
      DeduplicationScope: queue
      MessageRetentionPeriod: 1209600 # 14 days in minutes (max)
      ReceiveMessageWaitTimeSeconds: 0
      VisibilityTimeout: ${self:functions.ingestionPerformer.timeout}
      RedrivePolicy:
        deadLetterTargetArn:
          Fn::GetAtt: [ IngestionQueueDLQ, Arn ]
        maxReceiveCount: 1
  IngestionQueueDLQ:
    Type: AWS::SQS::Queue
    Properties:
      QueueName: ${self:custom.basename}-ingestion-dlq.fifo
      FifoQueue: true
      ContentBasedDeduplication: true
      DeduplicationScope: queue
      MessageRetentionPeriod: 1209600 # 14 days in minutes (max)

  OmieWebhookQueue:
    Type: AWS::SQS::Queue
    Properties:
      QueueName: ${self:custom.basename}-omieWebhook-queue.fifo
      FifoQueue: true
      ContentBasedDeduplication: true
      DeduplicationScope: queue
      MessageRetentionPeriod: 1209600 # 14 days in minutes (max)
      ReceiveMessageWaitTimeSeconds: 0
      VisibilityTimeout: ${self:functions.omieWebhook.timeout}
      RedrivePolicy:
        deadLetterTargetArn:
          Fn::GetAtt: [ OmieWebhookDLQ, Arn ]
        maxReceiveCount: 1
  OmieWebhookDLQ:
    Type: AWS::SQS::Queue
    Properties:
      QueueName: ${self:custom.basename}-omieWebhook-dlq.fifo
      FifoQueue: true
      ContentBasedDeduplication: true
      DeduplicationScope: queue
      MessageRetentionPeriod: 1209600 # 14 days in minutes (max)
  
  DataExportQueue:
    Type: AWS::SQS::Queue
    Properties:
      QueueName: ${self:custom.basename}-dataExport-queue.fifo
      FifoQueue: true
      ContentBasedDeduplication: true
      DeduplicationScope: queue
      MessageRetentionPeriod: 345600 # 4 days in minutes (default)
      ReceiveMessageWaitTimeSeconds: 0
      VisibilityTimeout: ${self:functions.dataExport.timeout}

  DataExportBucket:
    Type: AWS::S3::Bucket
    Properties:
      BucketName: ${self:custom.basename}-data-export
  
  DataProcessingQueue:
    Type: AWS::SQS::Queue
    Properties:
      QueueName: ${self:custom.basename}-dataProcessing-queue.fifo
      FifoQueue: true
      ContentBasedDeduplication: true
      DeduplicationScope: queue
      MessageRetentionPeriod: 345600 # 4 days in minutes (default)
      ReceiveMessageWaitTimeSeconds: 0
      VisibilityTimeout: ${self:functions.dataProcessing.timeout}

Outputs:
  RestApiUrl:
    Value: { 'Fn::Join': [ '', [ 'https://', { 'Ref' : 'ApiGatewayRestApi' }, '.execute-api.${self:provider.region}.amazonaws.com/${self:provider.stage}' ] ] }
    Export:
      Name: ${self:custom.basename}:RestApiUrl
  ApiKey:
    Value: ${self:custom.appApiKey.${self:provider.stage}}
    Export:
      Name: ${self:custom.basename}:ApiKey
  IngestionQueueArn:
    Value: !GetAtt IngestionQueue.Arn
    Export:
      Name: ${self:custom.basename}:IngestionQueueArn
  IngestionQueueUrl:
    Value: !Ref IngestionQueue
    Export:
      Name: ${self:custom.basename}:IngestionQueueUrl
  OmieWebhookQueueArn:
    Value: !GetAtt OmieWebhookQueue.Arn
    Export:
      Name: ${self:custom.basename}:OmieWebhookQueueArn
  OmieWebhookQueueUrl:
    Value: !Ref OmieWebhookQueue
    Export:
      Name: ${self:custom.basename}:OmieWebhookQueueUrl
  DataExportBucketArn:
    Value: !GetAtt DataExportBucket.Arn
    Export:
      Name: ${self:custom.basename}:DataExportBucketArn
  DataExportBucketName:
    Value: !Ref DataExportBucket
    Export:
      Name: ${self:custom.basename}:DataExportBucketName

  DataProcessingQueueArn:
    Value: !GetAtt DataProcessingQueue.Arn
    Export:
      Name: ${self:custom.basename}:DataProcessingQueueArn
  DataProcessingQueueUrl:
    Value: !Ref DataProcessingQueue
    Export:
      Name: ${self:custom.basename}:DataProcessingQueueUrl